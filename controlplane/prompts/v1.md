Fechou. Aqui vai o v1 em 1 página pra você colar pro Codex.

ControlPlane AI v1 (Convex + WorkOS + Vercel AI SDK)
1) Stack
Frontend: Next.js (App Router) + Vercel AI SDK
Auth/SSO: WorkOS (AuthKit + Organizations)
App backend realtime: Convex (queries, mutations, actions, scheduler)
Audit imutável: Postgres separado (audit_events append-only)
LLM Gateway: rota server-side própria (multi-provider)

2) Princípio de arquitetura
Convex toca produto e realtime.
Postgres toca compliance pesado e trilha imutável.
Nada de lógica crítica no client.

3) Módulos
Identity
login via WorkOS
mapeamento user -> organization -> role
Tenancy + RBAC
isolamento por orgId em toda query/mutation
roles: admin | user
Chat
conversa, mensagens, streaming status
UI com Vercel AI SDK
Policy Engine
allow | warn | redact | block
executa antes de chamar modelo
HITL
ações críticas viram approval_request
aprova/rejeita com justificativa
Audit
evento em toda ação relevante
grava em Convex + espelha no Postgres append-only

4) Fluxo principal (chat)
Usuário logado via WorkOS envia prompt
API resolve orgId/role
Policy engine avalia
Se block: retorna bloqueado e audita
Se redact: mascara e segue
Se precisa aprovação: cria request e pausa
Se aprovado: chama provider
Stream da resposta
Audit final (request, decision, model call, output metadata)

5) Modelo de dados mínimo
Convex
organizations
users
memberships
conversations
messages
policyRules
approvalRequests
approvalDecisions
usageMetrics

Postgres (append-only)
audit_events(id, ts, org_id, actor_id, action, resource, payload_json, hash, prev_hash)

6) Segurança mínima obrigatória
validação server-side de orgId em 100% das rotas
segredos só no servidor
policy check obrigatório antes de model call
PII redaction configurável por tenant
export de auditoria CSV/JSON por período
7) Sprint 1 (primeiros 5 dias)
WorkOS login + org mapping
Convex schema base (org, user, membership)
middleware RBAC
3 endpoints protegidos
audit_events no Postgres + writer service
tela simples: login, org atual, role atual, lista de conversas vazia

8) Definition of Done da Sprint 1
usuário só acessa dados da própria org
roles bloqueiam ações corretamente
todo acesso privado gera evento auditável
setup local sobe com 1 comando

---

Prompt pronto pro Codex
Implementar Foundation v1 do ControlPlane AI com Next.js + Convex + WorkOS + Postgres.
Requisitos:
1) Auth via WorkOS com organizations.
2) Modelo multi-tenant (organizations, users, memberships) com isolamento obrigatório por orgId.
3) RBAC (admin, user) em middleware server-side.
4) Estrutura de chat inicial (conversations, messages) sem LLM ainda.
5) Tabela Postgres audit_events append-only e serviço de escrita de auditoria para toda operação protegida.
6) Migrations, seed, testes básicos de autorização e README de setup.
Entregar código pronto para rodar localmente com pnpm dev.

Se você quiser, no próximo passo já te mando a árvore de pastas exata e o schema inicial (Convex + SQL).
