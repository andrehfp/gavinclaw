<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìÖ Shorts Scheduler</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #fff;
            padding: 20px;
        }
        .container { max-width: 800px; margin: 0 auto; }
        h1 { text-align: center; margin-bottom: 20px; }
        h1 span { color: #ff6b6b; }
        
        .section {
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .section-title {
            font-size: 1.1em;
            margin-bottom: 15px;
            color: #00d4aa;
        }
        
        .short-card {
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .short-info { flex: 1; }
        .short-title { font-weight: bold; margin-bottom: 5px; }
        .short-meta { font-size: 0.85em; color: rgba(255,255,255,0.6); }
        .short-status { padding: 4px 10px; border-radius: 15px; font-size: 0.8em; }
        .status-pending { background: #fbbf24; color: #000; }
        .status-scheduled { background: #00d4aa; color: #000; }
        .status-published { background: #60a5fa; color: #000; }
        
        .actions { display: flex; gap: 8px; }
        .btn {
            padding: 8px 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: transform 0.2s;
        }
        .btn:hover { transform: scale(1.05); }
        .btn-primary { background: #00d4aa; color: #000; }
        .btn-danger { background: #ff6b6b; color: #fff; }
        .btn-secondary { background: rgba(255,255,255,0.1); color: #fff; }
        
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-size: 0.9em; }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 8px;
            background: rgba(255,255,255,0.1);
            color: #fff;
            font-size: 14px;
        }
        .form-group textarea { min-height: 80px; resize: vertical; }
        
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: #1a1a2e;
            border-radius: 15px;
            padding: 25px;
            width: 90%;
            max-width: 500px;
        }
        .modal-title { margin-bottom: 20px; }
        
        .calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            margin-top: 15px;
        }
        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            font-size: 12px;
            cursor: pointer;
        }
        .calendar-day:hover { background: rgba(255,255,255,0.1); }
        .calendar-day.has-short { background: rgba(0,212,170,0.2); border: 1px solid #00d4aa; }
        .calendar-day .count { font-size: 10px; color: #00d4aa; }
        
        .available-shorts {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .available-short {
            background: rgba(255,255,255,0.05);
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .available-short:hover { background: rgba(0,212,170,0.2); }
        .available-short.selected { background: #00d4aa; color: #000; }
        
        .empty { text-align: center; padding: 30px; color: rgba(255,255,255,0.5); }
        
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #00d4aa;
            color: #000;
            padding: 12px 24px;
            border-radius: 10px;
            font-weight: bold;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 1001;
        }
        .toast.show { opacity: 1; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìÖ Shorts <span>Scheduler</span></h1>
        
        <div class="section">
            <div class="section-title">üìπ Shorts Dispon√≠veis</div>
            <div id="availableShorts" class="available-shorts">
                <div class="empty">Carregando...</div>
            </div>
        </div>
        
        <div class="section">
            <div class="section-title">üìÜ Agenda</div>
            <div id="scheduledShorts"></div>
        </div>
        
        <div class="section">
            <div class="section-title">‚öôÔ∏è Configura√ß√µes</div>
            <div class="form-group">
                <label>Hor√°rio padr√£o de postagem</label>
                <input type="time" id="defaultTime" value="10:00">
            </div>
            <div class="form-group">
                <label>Intervalo entre posts (horas)</label>
                <input type="number" id="intervalHours" value="24" min="1">
            </div>
            <button class="btn btn-primary" onclick="saveSettings()">Salvar configura√ß√µes</button>
        </div>
    </div>
    
    <div class="modal" id="scheduleModal">
        <div class="modal-content">
            <h3 class="modal-title">üìÖ Agendar Short</h3>
            <div class="form-group">
                <label>T√≠tulo</label>
                <input type="text" id="shortTitle" placeholder="T√≠tulo do short">
            </div>
            <div class="form-group">
                <label>Descri√ß√£o</label>
                <textarea id="shortDesc" placeholder="Descri√ß√£o e hashtags"></textarea>
            </div>
            <div class="form-group">
                <label>Data</label>
                <input type="date" id="shortDate">
            </div>
            <div class="form-group">
                <label>Hora</label>
                <input type="time" id="shortTime" value="10:00">
            </div>
            <div class="actions" style="margin-top: 20px;">
                <button class="btn btn-primary" onclick="confirmSchedule()">Agendar</button>
                <button class="btn btn-secondary" onclick="closeModal()">Cancelar</button>
            </div>
        </div>
    </div>
    
    <div class="toast" id="toast"></div>
    
    <script>
        let schedule = { shorts: [], settings: {} };
        let availableShorts = [];
        let selectedShort = null;
        
        async function loadData() {
            try {
                const [schedRes, shortsRes] = await Promise.all([
                    fetch('/api/schedule'),
                    fetch('/api/shorts')
                ]);
                schedule = await schedRes.json();
                availableShorts = await shortsRes.json();
                
                document.getElementById('defaultTime').value = schedule.settings?.default_time || '10:00';
                document.getElementById('intervalHours').value = schedule.settings?.interval_hours || 24;
                
                renderAvailable();
                renderScheduled();
            } catch (e) {
                console.error(e);
            }
        }
        
        function renderAvailable() {
            const container = document.getElementById('availableShorts');
            if (!availableShorts.length) {
                container.innerHTML = '<div class="empty">Nenhum short dispon√≠vel</div>';
                return;
            }
            
            const scheduled = new Set(schedule.shorts.map(s => s.filename));
            const unscheduled = availableShorts.filter(s => !scheduled.has(s.filename));
            
            if (!unscheduled.length) {
                container.innerHTML = '<div class="empty">Todos os shorts j√° est√£o agendados!</div>';
                return;
            }
            
            container.innerHTML = unscheduled.map(s => `
                <div class="available-short" onclick="selectShort('${s.filename}')">
                    üé¨ ${s.filename} (${s.size_mb}MB)
                </div>
            `).join('');
        }
        
        function renderScheduled() {
            const container = document.getElementById('scheduledShorts');
            const sorted = [...schedule.shorts].sort((a,b) => new Date(a.datetime) - new Date(b.datetime));
            
            if (!sorted.length) {
                container.innerHTML = '<div class="empty">Nenhum short agendado</div>';
                return;
            }
            
            container.innerHTML = sorted.map(s => {
                const dt = new Date(s.datetime);
                const status = s.published ? 'published' : (dt < new Date() ? 'pending' : 'scheduled');
                const statusText = s.published ? 'Publicado' : (dt < new Date() ? 'Pendente' : 'Agendado');
                
                return `
                    <div class="short-card">
                        <div class="short-info">
                            <div class="short-title">${s.title || s.filename}</div>
                            <div class="short-meta">
                                üìÖ ${dt.toLocaleDateString('pt-BR')} √†s ${dt.toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'})}
                            </div>
                        </div>
                        <span class="short-status status-${status}">${statusText}</span>
                        <div class="actions">
                            <button class="btn btn-danger" onclick="removeScheduled('${s.id}')">üóëÔ∏è</button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function selectShort(filename) {
            selectedShort = availableShorts.find(s => s.filename === filename);
            document.getElementById('shortTitle').value = filename.replace('.mp4', '').replace(/_/g, ' ');
            document.getElementById('shortDate').value = getNextDate();
            document.getElementById('shortTime').value = schedule.settings?.default_time || '10:00';
            document.getElementById('scheduleModal').classList.add('active');
        }
        
        function getNextDate() {
            const dates = schedule.shorts.map(s => new Date(s.datetime));
            let next = new Date();
            next.setDate(next.getDate() + 1);
            
            while (dates.some(d => d.toDateString() === next.toDateString())) {
                next.setDate(next.getDate() + 1);
            }
            
            return next.toISOString().split('T')[0];
        }
        
        function closeModal() {
            document.getElementById('scheduleModal').classList.remove('active');
            selectedShort = null;
        }
        
        async function confirmSchedule() {
            if (!selectedShort) return;
            
            const date = document.getElementById('shortDate').value;
            const time = document.getElementById('shortTime').value;
            
            const newShort = {
                id: Date.now().toString(),
                filename: selectedShort.filename,
                path: selectedShort.path,
                title: document.getElementById('shortTitle').value,
                description: document.getElementById('shortDesc').value,
                datetime: `${date}T${time}:00`,
                published: false
            };
            
            await fetch('/api/add', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(newShort)
            });
            
            closeModal();
            showToast('Short agendado!');
            loadData();
        }
        
        async function removeScheduled(id) {
            await fetch('/api/remove', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id })
            });
            showToast('Removido!');
            loadData();
        }
        
        async function saveSettings() {
            schedule.settings = {
                default_time: document.getElementById('defaultTime').value,
                interval_hours: parseInt(document.getElementById('intervalHours').value)
            };
            
            await fetch('/api/schedule', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(schedule)
            });
            showToast('Configura√ß√µes salvas!');
        }
        
        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2000);
        }
        
        loadData();
    </script>
</body>
</html>
